#!/bin/bash
#
# AKR Template Synchronization Hook
# Git post-merge hook for application repositories
#
# This hook:
# 1. Detects changes to .akr-config.json
# 2. Checks for updates in core-akr-templates repository
# 3. Notifies VS Code of configuration changes
#
# Installation:
#   Copy to .git/hooks/post-merge and make executable:
#   chmod +x .git/hooks/post-merge

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
TEMPLATES_DIR="$HOME/.akr/templates"
CONFIG_FILE=".akr-config.json"

echo -e "${BLUE}ðŸ”„ AKR Template Sync Hook${NC}"

# Function to check if file changed in merge
file_changed() {
    local file=$1
    git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD 2>/dev/null | grep -q "^${file}$"
}

# Function to update template repository
update_templates() {
    if [ ! -d "$TEMPLATES_DIR" ]; then
        echo -e "${YELLOW}âš   Template directory not found: $TEMPLATES_DIR${NC}"
        echo -e "${BLUE}â†’  Run setup script to clone core-akr-templates${NC}"
        return 1
    fi
    
    echo -e "${BLUE}â†’  Checking template repository for updates...${NC}"
    
    cd "$TEMPLATES_DIR"
    
    # Check if it's a git repository
    if [ ! -d ".git" ]; then
        echo -e "${RED}âœ—  Template directory is not a git repository${NC}"
        return 1
    fi
    
    # Fetch updates
    git fetch origin main --quiet
    
    # Check if updates are available
    LOCAL=$(git rev-parse HEAD)
    REMOTE=$(git rev-parse origin/main)
    
    if [ "$LOCAL" = "$REMOTE" ]; then
        echo -e "${GREEN}âœ“  Templates are up to date${NC}"
        return 0
    fi
    
    # Pull updates
    echo -e "${YELLOW}â†“  Pulling template updates...${NC}"
    git pull origin main --quiet
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ“  Templates updated successfully${NC}"
        
        # Show what changed
        git log --oneline --no-merges $LOCAL..HEAD | head -5 | while read line; do
            echo -e "  ${BLUE}â†’${NC} $line"
        done
        
        return 0
    else
        echo -e "${RED}âœ—  Failed to update templates${NC}"
        return 1
    fi
}

# Function to notify VS Code
notify_vscode() {
    local message=$1
    
    # Create notification file that VS Code extension can detect
    NOTIFICATION_FILE=".akr-notification.json"
    
    cat > "$NOTIFICATION_FILE" <<EOF
{
  "timestamp": "$(date -Iseconds)",
  "type": "template-sync",
  "message": "$message",
  "action": "reload-mcp-config"
}
EOF
    
    echo -e "${GREEN}âœ“  VS Code notification created${NC}"
}

# Main logic

# Check if .akr-config.json changed
if file_changed "$CONFIG_FILE"; then
    echo -e "${YELLOW}!  Configuration file changed: $CONFIG_FILE${NC}"
    
    # Validate JSON syntax
    if command -v jq &> /dev/null; then
        if jq empty "$CONFIG_FILE" 2>/dev/null; then
            echo -e "${GREEN}âœ“  Configuration is valid JSON${NC}"
        else
            echo -e "${RED}âœ—  Configuration has JSON syntax errors${NC}"
            echo -e "${YELLOW}â†’  Please fix $CONFIG_FILE before proceeding${NC}"
        fi
    fi
    
    # Update templates
    update_templates
    
    notify_vscode "Configuration and templates updated. Please reload MCP server."
    
    echo -e "\n${YELLOW}âš   Action Required:${NC}"
    echo -e "   Reload the MCP server in VS Code:"
    echo -e "   1. Open Command Palette (Ctrl+Shift+P)"
    echo -e "   2. Run: 'Developer: Reload Window'\n"
else
    # Check templates even if config didn't change
    if [ -d "$TEMPLATES_DIR" ]; then
        update_templates
    fi
fi

echo -e "${GREEN}âœ“  Post-merge hook completed${NC}\n"

exit 0

---
feature: TBD
domain: TBD
layer: Service
component: IEnrollmentService
status: deployed
version: '1.0'
componentType: Service
priority: TBD
lastUpdated: '2026-02-06'
---
<!--
  ü§ñ AI-GENERATED DOCUMENTATION

  Source File: TrainingTracker.Api/Domain/Services/IEnrollmentService.cs
  Component Type: service
  Template: lean_baseline_service_template.md
  Generated: 2026-02-06 17:11:50

  This documentation was generated by the AKR MCP Documentation Server.
  Sections marked with ü§ñ are AI-generated.
  Sections marked with ‚ùì need human input.

  Please review and enhance with business context before finalizing.
  Enhance with ‚ùì [HUMAN: ...] before merging
-->

# Enrollment Service Module Documentation

---

## Quick Reference (TL;DR)

**Service**: `EnrollmentService`  
**Purpose**: Manages user course enrollments with business rule validation  
**Key Operations**: List enrollments, get enrollment details, create enrollment, update status, delete enrollment  
**Tech Stack**: C# / .NET 9, Entity Framework Core, Dependency Injection  
**Lifetime**: Scoped (per HTTP request)  

| What | Where |
|------|-------|
| **Primary Responsibility** | Enforce business rules for user-course enrollment relationships |
| **Main Method** | `EnrollUserAsync(CreateEnrollmentRequest)` - Create with validation |
| **Key Rule** | Users cannot enroll in same course twice (BR-ENR-001) |
| **Dependencies** | `IEnrollmentRepository`, `IUserRepository`, `ICourseRepository` |
| **Failure Mode** | Returns 409 Conflict if business rule violation; 400 if bad input |

---

## What & Why

### What This Service Does

The **Enrollment Service** handles the business logic for managing user enrollments in courses:

- **Create enrollments** with full validation of users, courses, and business rules
- **Track enrollment status** (PENDING, COMPLETED, etc.) with timestamps
- **List and retrieve** enrollment records with pagination
- **Update enrollment status** with automatic completion timestamp tracking
- **Delete enrollment** records when no longer needed

### Why It Exists

Training organizations need to:
1. Allow users to enroll in courses through web and mobile interfaces
2. Enforce business rules (no duplicate enrollments, valid users/courses)
3. Track enrollment lifecycle (when enrolled, when completed)
4. Query enrollment history for reporting and compliance

**Business Value**:
- Prevents duplicate charges or confusion from duplicate enrollments
- Maintains data integrity by validating all referenced entities exist
- Provides audit trail of enrollment activity through timestamps
- Enables enrollment analytics and reporting

---

## How It Works

### Primary Operation: Create Enrollment

**Method**: `CreateAsync(CreateEnrollmentRequest request, CancellationToken ct)`

**Flow**:

```
User enrolls via EnrollmentsController
         ‚Üì
CreateAsync(userId, courseId)
         ‚Üì
Validate: User exists in database
         ‚Üì
Validate: Course exists in database
         ‚Üì
Check: User-Course enrollment doesn't already exist
         ‚Üì (All validations pass)
Create: New Enrollment entity (Status = PENDING)
         ‚Üì
Set: EnrolledUtc = DateTime.UtcNow
         ‚Üì
Save: Insert to database via repository
         ‚Üì
Return: EnrollmentDetailDto with new enrollment
         ‚Üì
Controller returns: HTTP 201 Created
```

**Success**: Returns `EnrollmentDetailDto` with new enrollment ID  
**Failure Paths**:
- User doesn't exist ‚Üí `InvalidOperationException("User ... does not exist")`
- Course doesn't exist ‚Üí `InvalidOperationException("Course ... does not exist")`
- Already enrolled ‚Üí `InvalidOperationException("User is already enrolled in this course")`

### Secondary Operations

| Operation | Method | Purpose | Main Validation |
|-----------|--------|---------|-----------------|
| List enrollments | `ListAsync(page, pageSize)` | Paginated retrieval with sorting | None (read-only) |
| Get enrollment | `GetAsync(id)` | Retrieve single enrollment details | Enrollment must exist |
| Update status | `UpdateStatusAsync(id, status)` | Change enrollment status | Enrollment must exist |
| Delete enrollment | `DeleteAsync(id)` | Remove enrollment record | Enrollment must exist |

**Update Status Flow**:
```
UpdateStatusAsync(enrollmentId, newStatus)
         ‚Üì
Find: Existing enrollment by ID
         ‚Üì (If not found)
Return: null (caller returns 404)
         ‚Üì (If found)
Update: enrollment.Status = newStatus
         ‚Üì (If status is COMPLETED)
Set: enrollment.CompletedUtc = DateTime.UtcNow
         ‚Üì
Save: Update to database via repository
         ‚Üì
Return: Updated EnrollmentDetailDto
```

---

## Business Rules

ü§ñ **AI Note**: Rules extracted from `IEnrollmentService` and `EnrollmentsController` implementation

| Rule ID | Description | Business Rationale | Since Version |
|---------|-------------|-------------------|----------------|
| BR-ENR-001 | User cannot enroll in same course twice | Prevent duplicate enrollments, avoid duplicate charges, reduce user confusion | v1.0 |
| BR-ENR-002 | User must exist to enroll | Maintain referential integrity; enrollment requires valid user | v1.0 |
| BR-ENR-003 | Course must exist to enroll | Maintain referential integrity; enrollment requires valid course | v1.0 |
| BR-ENR-004 | Completion timestamp set on COMPLETED status | Track when user finished course for reporting and compliance | v1.0 |
| BR-ENR-005 | Enrollment timestamp set at creation | Audit trail of when enrollment occurred for reporting | v1.0 |

---

## Architecture

### Dependencies (Constructor Injection)

| Dependency | Type | Lifetime | Purpose | Failure Mode |
|------------|------|----------|---------|-------------|
| `IEnrollmentRepository` | Interface | Scoped | Database access for enrollment CRUD | ‚ö†Ô∏è Blocking - DB unavailable ‚Üí service fails |
| `IUserRepository` | Interface | Scoped | Validate user exists during enrollment | ‚ö†Ô∏è Blocking - returns null ‚Üí InvalidOperationException |
| `ICourseRepository` | Interface | Scoped | Validate course exists during enrollment | ‚ö†Ô∏è Blocking - returns null ‚Üí InvalidOperationException |

**Rationale**: All dependencies injected via constructor during service registration in `Program.cs`

### Consumers (Who Uses This Service)

| Consumer | Use Case | Impact of Failure |
|----------|----------|-------------------|
| `EnrollmentsController` | User enrolls via web/API | HTTP error (400/409/500) returned to client |
| `EnrollmentsController` | List enrollments on dashboard | HTTP 500, enrollment list fails to load |
| (Future: Mobile app) | Mobile enrollment flow | API error propagated to mobile client |

---

## API Contract (AI Context)

ü§ñ **AI Note**: API routes and response models extracted from `EnrollmentsController`

### Routes

| HTTP Method | Route | Operation | Response Status |
|------------|-------|-----------|-----------------|
| GET | `/api/enrollments` | List enrollments | 200 OK |
| GET | `/api/enrollments/{id:guid}` | Get enrollment by ID | 200 OK / 404 Not Found |
| POST | `/api/enrollments` | Create enrollment | 201 Created / 400 Bad Request / 409 Conflict |
| PATCH | `/api/enrollments/{id:guid}/status` | Update enrollment status | 200 OK / 400 Bad Request / 404 Not Found |
| DELETE | `/api/enrollments/{id:guid}` | Delete enrollment | 204 No Content / 404 Not Found |

### Request Models

**CreateEnrollmentRequest**:
```
{
  "userId": "guid (required)",
  "courseId": "guid (required)"
}
```

**UpdateEnrollmentStatusRequest**:
```
{
  "status": "string (required, e.g., 'PENDING', 'COMPLETED')"
}
```

### Response Models

**EnrollmentDetailDto** (POST, GET, PATCH responses):
```
{
  "id": "guid",
  "userId": "guid",
  "courseId": "guid",
  "status": "string",
  "enrolledUtc": "datetime (nullable)",
  "completedUtc": "datetime (nullable)"
}
```

**PagedResponse<EnrollmentSummaryDto>** (GET list response):
```
{
  "items": [
    {
      "id": "guid",
      "userId": "guid",
      "courseId": "guid",
      "status": "string",
      "enrolledUtc": "datetime (nullable)",
      "completedUtc": "datetime (nullable)"
    }
  ],
  "page": "int",
  "pageSize": "int",
  "totalCount": "int"
}
```

---

## Validation Rules (AUTO-GENERATED)

ü§ñ **AI Note**: Validation rules extracted from `IEnrollmentService.CreateAsync` implementation

### Input Validation (Technical)

| Parameter | Rule | Exception Type | Message |
|-----------|------|-----------------|---------|
| `request.UserId` | Cannot be null, must be valid Guid | `ArgumentException` or `InvalidOperationException` | "User with ID '...' does not exist" |
| `request.CourseId` | Cannot be null, must be valid Guid | `ArgumentException` or `InvalidOperationException` | "Course with ID '...' does not exist" |
| `status` (Update) | Non-null string | (Handled by model binding) | (Implicit from model validation) |
| `id` (Get/Update/Delete) | Valid Guid, not Empty | (Implicit in route constraint) | (404 if not found) |

### Business Validation

| Rule | Validation Logic | Exception | Error Message |
|------|------------------|-----------|-----|
| User existence | `userRepo.GetAsync(userId) != null` | `InvalidOperationException` | "User with ID '{userId}' does not exist" |
| Course existence | `courseRepo.GetAsync(courseId) != null` | `InvalidOperationException` | "Course with ID '{courseId}' does not exist" |
| No duplicate enrollment | `enrollmentRepo.GetByUserAndCourseAsync(userId, courseId) == null` | `InvalidOperationException` | "User is already enrolled in this course" |
| Valid status transitions | Status value provided (no enum validation in code) | (No explicit validation) | ‚ùì Needs clarification |

### Validation Order

1. **Input validation** - HTTP request parsing (handled by ASP.NET Core model binding)
2. **Entity existence** - User and Course must be retrievable from database
3. **Business rules** - Duplicate enrollment check
4. **Database persistence** - EF Core save validation

---

## Data Operations

ü§ñ **AI Note**: Data operations extracted from repository interfaces and service implementation

### Reads From

| Table/Source | Called By | Purpose | Business Context |
|--------------|-----------|---------|------------------|
| `training.Enrollments` | `GetAsync(id)`, `GetByUserAndCourseAsync(userId, courseId)`, `ListAsync(page, pageSize)` | Retrieve enrollment records | Validate enrollment exists, prevent duplicates, list enrollments |
| `training.Users` | `userRepo.GetAsync(userId)` | Verify user existence | Ensure user is valid before creating enrollment (BR-ENR-002) |
| `training.Courses` | `courseRepo.GetAsync(courseId)` | Verify course existence | Ensure course is valid before creating enrollment (BR-ENR-003) |

### Writes To

| Table/Destination | Operation | Called By | Business Purpose |
|-------------------|-----------|-----------|------------------|
| `training.Enrollments` | INSERT | `CreateAsync(enrollment)` via repository | Create new enrollment record (BR-ENR-005 timestamp tracking) |
| `training.Enrollments` | UPDATE | `UpdateAsync(enrollment)` via repository | Update enrollment status and completion timestamp (BR-ENR-004) |
| `training.Enrollments` | DELETE | `DeleteAsync(id)` via repository | Remove enrollment record when needed |

### Side Effects

| Side Effect | Triggered | Blocking? | Business Purpose |
|-------------|-----------|-----------|------------------|
| (No documented side effects - check implementation) | - | - | ‚ùì Needs clarification: Does enrollment trigger email notifications? |

‚ùì **Question**: Does successful enrollment trigger email confirmation to user? Current code doesn't show side effects, but typical enrollment flow includes notification.

---

## Questions & Gaps

‚ùì **Needs Human Input**:

1. **Status Transitions**: 
   - What status values are valid? (Currently just "PENDING", "COMPLETED" in comments)
   - Are there invalid status transitions? (e.g., COMPLETED ‚Üí PENDING not allowed?)
   - What status values map to what user-facing states?

2. **Timestamps**:
   - Why are `EnrolledUtc` and `CompletedUtc` marked `[NotMapped]`?
   - Should they be persisted to database? (Currently only in-memory)
   - Do they cause issues with Entity Framework Core tracking?

3. **Side Effects**:
   - Does enrollment trigger email confirmation to user?
   - Does enrollment trigger notifications to course instructor?
   - Does enrollment create audit log entries?
   - Are there any background jobs triggered?

4. **Error Codes**:
   - What HTTP status codes are mapped by ExceptionHandlingMiddleware?
   - Are there specific error codes for different failure modes?
   - How does 409 Conflict get returned for InvalidOperationException?

5. **Pagination**:
   - What's the default page size? (Currently 10 in controller)
   - Are there limits on max page size?
   - How should enrollments be sorted? (Current sort by EnrolledUtc in InMemoryRepository)

6. **Performance**:
   - Are database indexes on (UserId, CourseId) for duplicate check?
   - Expected throughput? (enrollments per second)
   - Typical result set sizes? (average enrollments returned)

---

## Optional Sections (Add When Needed)

‚è≥ **Consider adding these sections when:**

- **Performance Considerations** ‚Üí When production metrics show bottlenecks or slow queries
- **Known Issues & Limitations** ‚Üí When bugs or workarounds are discovered
- **External Dependencies** ‚Üí If integrating with third-party APIs or services
- **Common Problems & Solutions** ‚Üí When support tickets reveal patterns
- **Security & Authorization** ‚Üí If special access control or data sensitivity exists
- **Testing Guidance** ‚Üí For complex test setup or integration test patterns
- **Alternative Paths** ‚Üí When service has complex conditional logic or workflows

**Trigger**: Add section only when the information exists and would be valuable for the team.

---

## Maintenance Checklist

- [ ] When adding new status values, update Business Rules table (BR-ENR-004)
- [ ] When changing validation logic, update Validation Rules section
- [ ] When adding side effects, document in Side Effects table
- [ ] When adding new dependencies, update Dependencies table with failure modes
- [ ] Keep status transition diagram updated (if exists)
- [ ] Review Questions & Gaps quarterly for resolved items
- [ ] Test enrollment workflow after any status changes
- [ ] Update API Contract section if routes or models change
- [ ] Keep Related Documentation links current

---

## Documentation Standards

### Writing Guidelines

- **Be concise**: Use tables and bullet points over prose
- **Be explicit**: "User cannot enroll twice" better than "no duplicate enrollments"
- **Include WHY**: Business rationale matters more than technical details
- **Use consistent terminology**: "enrollment status", not "enrollment state" or "status code"
- **Link to sources**: Reference source code file names and line numbers

### Structure Standards

- **Section order**: Follow AKR template structure
- **Headings**: Use H2 for major sections, H3 for subsections
- **Tables**: Use markdown tables for structured data
- **Code**: Use relevant language syntax highlighting (csharp, sql, json)
- **Marking**: Use ü§ñ for AI-generated content, ‚ùì for gaps, ‚è≥ for optional

### Maintenance Standards

- Update documentation in same PR as code changes
- Include documentation updates in commit messages
- Review quarterly for accuracy and relevance
- Track broken links in Questions & Gaps section

---

## AI Generation Instructions

**For regenerating or updating this documentation:**

```
Component: Enrollment Service
Template: lean_baseline_service_template.md
Type: service

Source Files:
- TrainingTracker.Api/Domain/Services/IEnrollmentService.cs
- TrainingTracker.Api/Domain/Repositories/IEnrollmentRepository.cs
- TrainingTracker.Api/Domain/Entities/Enrollment.cs
- TrainingTracker.Api/Controllers/EnrollmentsController.cs

Extract:
1. Service identity: Name, namespace, responsibility
2. Public methods: Signatures, parameters, return types
3. Dependencies: Constructor injection points
4. Business rules: From validation and business logic
5. API routes: From controller attributes
6. Data operations: From repository calls
7. Error handling: From exception throws
8. Validation: From business rule checks

Flag for human review:
- Magic numbers or hardcoded values
- Comments marked "TODO", "FIXME", "temporary"
- Complex conditional logic
- External service calls
- Performance considerations
- Async/await patterns
```

---

## Minimum Viable Documentation

**What must be included for any service:**

1. ‚úÖ **Quick Reference** - Name, purpose, key rule
2. ‚úÖ **What & Why** - Business context for why service exists
3. ‚úÖ **How It Works** - Primary operation with flow
4. ‚úÖ **Business Rules** - BR-ID format with rationale
5. ‚úÖ **API Contract** - Routes, request/response models
6. ‚úÖ **Validation Rules** - Input and business validation
7. ‚úÖ **Architecture** - Dependencies with failure modes
8. ‚úÖ **Questions & Gaps** - Unknown items flagged for team

**Time to baseline**: 20-30 minutes with AI assistance

---

## Recommended Sections (Include When Applicable)

**Add these sections when the information exists:**

- ‚úÖ **Data Operations** ‚Üí Service reads/writes database (applicable: add always)
- ‚úÖ **Related Documentation** ‚Üí Links to other services, APIs, databases
- ‚úÖ **Change History** ‚Üí Track documentation evolution

---

## Optional Sections (Add When Valuable)

**Add only if truly valuable to team:**

- ‚è≥ **Configuration** - If service has configuration settings
- ‚è≥ **Performance Considerations** - If production metrics show concerns
- ‚è≥ **Known Issues & Limitations** - If bugs or workarounds exist
- ‚è≥ **Common Problems & Solutions** - If support patterns exist
- ‚è≥ **Security & Authorization** - If special access control exists
- ‚è≥ **Testing Guidance** - If complex test setup required
- ‚è≥ **External Dependencies** - If third-party integrations exist

---

## Related Documentation

- **API Documentation**: See `EnrollmentsController` endpoint documentation
- **Database Schema**: See Enrollments table documentation in database repository
- **User Service**: See `UserService` documentation for user validation patterns
- **Course Service**: See `CourseService` documentation for course validation patterns
- **Error Handling**: See `ExceptionHandlingMiddleware` for error response mapping
- **AKR Charter**: See `AKR_CHARTER_BACKEND.md` for backend documentation standards

---

## Change History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-02-06 | Initial documentation generation using lean_baseline_service_template.md |

---

## How to Use This Template

### For Service Teams

1. **Create documentation** when service is created or redesigned
2. **Maintain documentation** when code changes (update in same PR)
3. **Review quarterly** for accuracy and completeness
4. **Use sections** to guide team understanding and onboarding

### For Reviewers

1. **Check completeness**: Are all baseline sections present?
2. **Check accuracy**: Do tables match code implementation?
3. **Check clarity**: Is business WHY explained, not just technical WHAT?
4. **Check currency**: Are Questions & Gaps being resolved?

### For AI Generation

1. Extract technical details (methods, dependencies, exceptions)
2. Create tables and flows from code analysis
3. Flag items needing human context (business rules, rationale)
4. Follow AKR conventions and section order
5. Mark AI-generated (ü§ñ) vs. needs human input (‚ùì)

---

## Quick Reference for Service Documentation

### Service Documentation Layers

| Layer | Content | Purpose | Owner |
|-------|---------|---------|-------|
| **Layer 1: Quick Ref** | Name, purpose, key rule | 30-second understanding | AI + Human |
| **Layer 2: Business** | Why, rules, architecture | Team alignment | Human-led |
| **Layer 3: Technical** | APIs, validation, data ops | Implementation guide | AI-generated |
| **Layer 4: Details** | Edge cases, performance, issues | Troubleshooting | Human-curated |

### Common Documentation Patterns

**Pattern: Business Rule Documentation**
```
| BR-[SVC]-### | Rule description | Business rationale | Version |
```

**Pattern: Dependency Documentation**
```
| Dependency | Purpose | Lifetime | Failure Mode |
```

**Pattern: Data Operation Documentation**
```
| Table | Operation | Purpose | Business Context |
```

---

## Template Metadata

**Template Name**: `lean_baseline_service_template.md`  
**Version**: 1.0  
**Applies To**: Backend service/business logic layer services  
**Scope**: ASP.NET Core services, Node.js services, Java Spring services, etc.

**Baseline Sections** (required, 20-30 minutes):
- Quick Reference (TL;DR)
- What & Why
- How It Works
- Business Rules
- Architecture
- API Contract (AI Context)
- Validation Rules (AUTO-GENERATED)
- Data Operations
- Questions & Gaps

**Optional Sections** (add as needed, events-driven):
- Configuration
- Performance Considerations
- Known Issues & Limitations
- Common Problems & Solutions
- Security & Authorization
- Testing Guidance
- External Dependencies

**Last Updated**: 2026-02-06  
**Maintained By**: Training Tracker Team  
**Related Charters**: AKR_CHARTER.md, AKR_CHARTER_BACKEND.md